---
title: Azure Stack Hub にデプロイされた VM の保護
description: データ損失や計画外のダウンタイムから Azure Stack Hub にデプロイされた VM を保護するための復旧計画の作成方法について説明します。
author: mattbriggs
ms.topic: conceptual
ms.date: 1/22/2020
ms.author: mabrigg
ms.reviewer: hectorl
ms.lastreviewed: 3/19/2019
ms.openlocfilehash: 824352a27ae91b2bf0a351b9dc280c83bfb9d19a
ms.sourcegitcommit: 4ac711ec37c6653c71b126d09c1f93ec4215a489
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/27/2020
ms.locfileid: "77703963"
---
# <a name="protect-vms-deployed-on-azure-stack-hub"></a>Azure Stack Hub にデプロイされた VM の保護

この記事は、ユーザーが Azure Stack Hub にデプロイする仮想マシン (VM) を保護するためのプランを作成するためのガイドとして使用します。


データ損失や計画外のダウンタイムから保護するには、ユーザー アプリとそのデータのバックアップと回復またはディザスター リカバリー計画を実装する必要があります。 この計画はアプリごとに一意である場合がありますが、組織の包括的なビジネス継続性およびディザスター リカバリー (BC/DR) 戦略によって確立されたフレームワークに従います。 最初に、「[Azure Stack Hub: Considerations for business continuity and disaster recovery](https://aka.ms/azurestackbcdrconsiderationswp)」を参照することをお勧めします。

## <a name="azure-stack-hub-infrastructure-recovery"></a>Azure Stack Hub インフラストラクチャの復旧

ユーザーは、Azure Stack Hub のインフラストラクチャ サービスとは別に自分の VM を保護する責任があります。

Azure Stack Hub インフラストラクチャ サービスの復旧計画には、ユーザー VM、ストレージ アカウント、またはデータベースの復旧は**含まれません**。 アプリとデータの復旧計画は、アプリの所有者が実装する必要があります。

Azure Stack Hub クラウドが長時間オフラインになっているか、永久に回復不能な状態の場合は、次のような復旧計画を立てる必要があります。

* ダウンタイムを最小限に抑える。
* 重要な VM (データベース サーバーなど) を実行したままにする。
* アプリが引き続きユーザー要求に対応できるようにする。

Azure Stack Hub クラウドのオペレーターは、基になる Azure Stack Hub インフラストラクチャとサービスの復旧計画を作成する役割を担います。 詳細については、「[致命的なデータの損失からの復旧](../operator/azure-stack-backup-recover-data.md)」を参照してください。

## <a name="considerations-for-iaas-vms"></a>IaaS VM に関する考慮事項
IaaS VM にインストール済みのオペレーティング システムでは、IaaS VM に含まれているデータを保護するためにユーザーが使用できる製品が制限されます。 Windows ベースの IaaS VM では、データを保護するために Microsoft 製品とパートナー製品を使用できます。 Linux ベースの IaaS VM では、パートナー製品を使用することが唯一の選択肢です。 [Azure Stack Hub で検証済みの製品を持つすべての BC/DR パートナーに関するこのデータシート](https://aka.ms/azurestackbcdrpartners)を参照してください。

## <a name="sourcetarget-combinations"></a>ソースとターゲットの組み合わせ

各 Azure Stack Hub クラウドは、1 つのデータ センターにデプロイされます。 アプリを回復するには、別の環境が必要になります。 この回復環境は、別のデータセンターの別の Azure Stack Hub クラウドとすることも、Azure パブリック クラウドとすることもできます。 データの主権とデータのプライバシーの要件によって、アプリの回復環境が決まります。 アプリごとに保護を有効にすると、各アプリに固有の回復オプションを柔軟に選択できます。 1 つのサブスクリプションのアプリで、別のデータ センターにデータをバックアップすることができます。 別のサブスクリプションでは、Azure パブリック クラウドにデータをレプリケートできます。

各アプリのバックアップと回復およびディザスター リカバリー戦略を計画して、アプリごとにターゲットを決定します。 回復計画により、組織はオンプレミスで必要なストレージ容量の設定とパブリック クラウドでの使用量の見積もりを適切に行うことができます。

|  | グローバル Azure | CSP のデータ センターにデプロイされ、CSP が運用する Azure Stack Hub | お客様のデータ センターにデプロイされ、お客様が運用する Azure Stack Hub |
|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| **CSP のデータ センターにデプロイされ、CSP が運用する Azure Stack Hub** | ユーザー VM は、CSP が運用する Azure Stack Hub にデプロイされます。<br><br>ユーザー VM はバックアップから復元されるか、Azure に直接フェールオーバーされます。 | CSP が独自のデータ センターで Azure Stack Hub のプライマリおよびセカンダリ インスタンスを運用します。<br><br>ユーザー VM は、2 つの Azure Stack Hub インスタンス間で復元またはフェールオーバーされます。 | CSP がプライマリ サイトで Azure Stack Hub を運用します。<br><br>お客様のデータ センターが、復元またはフェールオーバーのターゲットになります。 |
| **お客様のデータ センターにデプロイされ、お客様が運用する Azure Stack Hub** | ユーザー VM は、お客様が運用する Azure Stack Hub にデプロイされます。<br><br>ユーザー VM はバックアップから復元されるか、Azure に直接フェールオーバーされます。 | お客様がプライマリ サイトで Azure Stack Hub を運用します。<br><br>CSP のデータ センターが、復元またはフェールオーバーのターゲットになります。 | お客様が独自のデータ センターで Azure Stack Hub のプライマリおよびセカンダリ インスタンスを運用します。<br><br>ユーザー VM は、2 つの Azure Stack Hub インスタンス間で復元またはフェールオーバーされます。 |

![ソースとターゲットの組み合わせ](media/azure-stack-manage-vm-backup/vm_backupdataflow_01.png)

## <a name="app-recovery-objectives"></a>アプリの回復目標

組織がアプリごとに許容できるダウンタイムとデータ損失の量を決定します。 ダウンタイムとデータ損失を定量化することで、障害による組織への影響を最小限に抑える回復計画を作成できます。 アプリごとに、次を検討してください。

 - **目標復旧時間 (RTO)**  
RTO は、インシデントの発生後に、アプリを使用不可状態にすることができる最大許容時間です。 たとえば、RTO が 90 分の場合、災害発生から 90 分以内にアプリを実行状態に復元できなければならないことを意味します。 RTO を短くする場合は、リージョンの障害から保護するために、2 つ目のデプロイをスタンバイ状態で継続的に実行します。
 - **目標復旧時点 (RPO)**  
RPO は、障害発生時に許容できるデータ損失の最大期間です。 たとえば、1 時間ごとにバックアップされる単一データベースにデータを格納していて、他のデータベースへのレプリケーションがない場合、最大 1 時間のデータを失う可能性があります。

RTO と RPO はビジネス要件です。 リスク評価を実施して、アプリの RTO と RPO を定義します。

もう 1 つのメトリックは、**平均復旧時間** (MTTR) です。MTTR は、障害発生後にアプリの復元にかかる平均時間です。 MTTR はシステムの経験値です。 MTTR が RTO を超えると、システム障害の結果、定義されている RTO 以内にシステムを復元できなくなるため、許容できないビジネスの中断が発生します。

### <a name="backup-restore"></a>バックアップと復元

VM ベースのアプリの最も一般的な保護スキームは、バックアップ ソフトウェアを使用することです。 通常、VM のバックアップには、オペレーティング システム、オペレーティング システム構成、アプリ バイナリ、アプリ データが含まれます。 ボリューム、ディスク、または VM 全体のスナップショットを作成することで、バックアップが作成されます。 Azure Stack Hub を使用すると、ゲスト OS のコンテキスト内から、または Azure Stack Hub ストレージおよびコンピューティング API からバックアップする柔軟性が得られます。 Azure Stack Hub では、ハイパーバイザー レベルでのバックアップの作成はサポートされていません。
 
![バックアップと復元](media/azure-stack-manage-vm-backup/vm_backupdataflow_03.png)

アプリを回復するには、1 つ以上の VM を同じクラウドまたは新しいクラウドに復元する必要があります。 データ センターのクラウドをターゲットにすることも、パブリック クラウドをターゲットにすることもできます。 選択するクラウドは、データのプライバシーと主権の要件に基づいて、完全に制御できます。

 - RTO: 時間単位で測定されたダウンタイム
 - RPO: 変動するデータ損失 (バックアップの頻度に依存)
 - デプロイ トポロジ: アクティブ/パッシブ

#### <a name="planning-your-backup-strategy"></a>バックアップ戦略の計画

バックアップ戦略を計画し、スケール要件を定義するには、まず、保護する必要がある VM インスタンスの数を定量化します。 環境内のすべてのサーバーのすべての VM をバックアップするのが一般的な戦略です。 ただし、Azure Stack Hub では、一部の VM についてバックアップを行う必要があります。 たとえば、スケール セット内の VM は、場合によっては予告なしに追加または削除される可能性がある一時的なリソースと見なされます。 保護する必要がある永続的なデータは、データベースやオブジェクト ストアなどの別のリポジトリに格納します。

Azure Stack Hub の VM のバックアップに関する重要な考慮事項を次に示します。

 - **カテゴリ化**
    - ユーザーが VM のバックアップを選択するモデルを検討します。
    - アプリの優先順位またはビジネスへの影響に基づいて回復のサービス レベル アグリーメント (SLA) を定義します。
 - **スケール**
    - 多数の新しい VM をオンボードするときは、時間を少しずつずらしたバックアップを検討します (バックアップが必要な場合)。
    - ソリューションのリソース コンテンツを最小限にするために、バックアップ データを効率的に取り込んで送信できるバックアップ製品を評価します。
    - 環境内のすべての VM での完全バックアップの必要性を最小限に抑えるために、増分バックアップまたは差分バックアップを使用してバックアップ データを効率的に保存するバックアップ製品を評価します。
 - **復元**
    - バックアップ製品では、仮想ディスク、既存の VM 内のアプリ データ、または VM リソース全体と関連する仮想ディスクを復元できます。 必要な復元スキームは、アプリの復元をどのように計画するかによって異なります。 たとえば、VM 全体または VM のセットを復元するのではなく、テンプレートから SQL Server を再デプロイし、データベースを復元する方が簡単な場合もあります。

### <a name="replicationmanual-failover"></a>レプリケーション/手動フェールオーバー

高可用性をサポートする別の方法として、アプリ VM を別のクラウドにレプリケートし、手動フェールオーバーを利用します。 オペレーティング システム、アプリ バイナリ、アプリ データのレプリケーションは、VM レベルまたはゲスト OS レベルで実行できます。 フェールオーバーの管理には、アプリには含まれていないその他のソフトウェアが使用されています。

この方法を使用すると、アプリはあるクラウドにデプロイされ、その VM は別のクラウドにレプリケートされます。 フェールオーバーがトリガーされた場合、2 つ目のクラウドでセカンダリ VM の電源をオンにする必要があります。 シナリオによっては、フェールオーバーによって VM が作成され、その VM にディスクがアタッチされます。 特に、特定の起動シーケンスを必要とする多層アプリでは、このプロセスが完了するまでに長時間がかかる可能性があります。 アプリが要求への対応を開始できる状態になる前に実行する必要がある手順もあります。

![レプリケーション/手動フェールオーバー](media/azure-stack-manage-vm-backup/vm_backupdataflow_02.png)

 - RTO: 分単位で測定されたダウンタイム
 - RPO: 変動するデータ損失 (レプリケーションの頻度に依存)
 - デプロイ トポロジ: アクティブ/パッシブ スタンバイ
 
### <a name="high-availabilityautomatic-failover"></a>高可用性/自動フェールオーバー

ビジネスで許容できるダウンタイムが数秒または数分であり、データ損失を最小限に抑える必要があるアプリの場合、高可用性構成を検討してください。 高可用性アプリは、障害から迅速かつ自動的に回復するように設計されています。 ローカル ハードウェア障害に備えて、Azure Stack Hub インフラストラクチャでは、2 つのトップ オブ ラック スイッチを使用して物理ネットワークで高可用性が実装されます。 コンピューティング レベルの障害に備えて、Azure Stack Hub ではスケール ユニット内の複数のノードが使用されます。 VM レベルでは、ノードの障害によってアプリが停止しないように、スケール セットを障害ドメインと組み合わせてご利用いただけます。

スケール セットと組み合わせる場合、アプリは高可用性をネイティブにサポートするか、クラスタリング ソフトウェアの使用をサポートする必要があります。 たとえば、Microsoft SQL Server では、同期コミット モードを使用してデータベースの高可用性をネイティブにサポートします。 ただし、非同期レプリケーションしかサポートできない場合は、一部のデータが失われます。 クラスタリング ソフトウェアがアプリの自動フェールオーバーを処理するフェールオーバー クラスターに、アプリをデプロイすることもできます。

この方法を使用すると、アプリは 1 つのクラウドでのみアクティブですが、ソフトウェアは複数のクラウドにデプロイされます。 他のクラウドはスタンバイ モードであり、フェールオーバーがトリガーされたときに、アプリを起動する準備ができています。

 - RTO: 秒単位で測定されたダウンタイム
 - RPO: 最小限のデータ損失
 - デプロイ トポロジ: アクティブ/アクティブ スタンバイ

### <a name="fault-tolerance"></a>フォールト トレランス

Azure Stack Hub の物理的な冗長性とインフラストラクチャ サービスの可用性によって実現されるのは、ディスク、電源、ネットワーク ポート、ノードなどのハードウェア レベルの障害やエラーからの保護に限られます。 ただし、アプリの可用性を常に維持する必要があり、データを一切失うことができない場合は、アプリにフォールト トレランスをネイティブに実装するか、追加のソフトウェアを使用してフォールト トレランスを有効にする必要があります。

まず、ノード レベルの障害から保護するために、アプリ VM がスケール セットを使用してデプロイされていることを確認する必要があります。 オフラインになるクラウドから保護するには、同じアプリが別のクラウドに既にデプロイされている必要があります。これにより、アプリは中断なしに引き続き要求に対応できます。 通常、このモデルはアクティブ/アクティブ デプロイと呼ばれます。

各 Azure Stack Hub クラウドは相互に独立しているため、インフラストラクチャの観点から、クラウドは常にアクティブと見なされることに留意してください。 この場合、アプリの複数のアクティブなインスタンスが、1 つ以上のアクティブなクラウドにデプロイされます。

 - RTO: ダウンタイムなし
 - RPO: データ損失なし
 - デプロイ トポロジ: アクティブ/アクティブ

### <a name="no-recovery"></a>復旧不要

環境内の一部のアプリは、計画外のダウンタイムやデータ損失から保護する必要がない場合があります。 たとえば、開発やテストに使用される VM は、通常、復旧する必要はありません。 アプリまたは特定の VM の保護なしで済ませるかどうかは自由に決めることができます。 Azure Stack Hub では、基になるインフラストラクチャからの VM のバックアップやレプリケーションは提供していません。 Azure と同様に、各サブスクリプションの VM ごとに保護を選択する必要があります。

 - RTO: 回復不能
 - RPO: 完全なデータ損失

## <a name="recommended-topologies"></a>推奨されるトポロジ

Azure Stack Hub のデプロイに関する重要な考慮事項を次に示します。

|     | 推奨 | 説明 |
|-------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| データ センターに既にデプロイされている外部バックアップ ターゲットに VM をバックアップ/復元する | 推奨 | 既存のバックアップ インフラストラクチャと運用スキルを活用します。 追加の VM インスタンスをすぐに保護できるように、バックアップ インフラストラクチャのサイズを必ず設定します。 バックアップ インフラストラクチャが、ソースに近接する場所にないことを確認します。 VM は、ソース Azure Stack Hub、セカンダリ Azure Stack Hub インスタンス、または Azure に復元できます。 |
| Azure Stack Hub 専用の外部バックアップ ターゲットに VM をバックアップおよび復元する | 推奨 | 新しいバックアップ インフラストラクチャを購入することも、Azure Stack Hub 専用のバックアップ インフラストラクチャをプロビジョニングすることもできます。 バックアップ インフラストラクチャが、ソースに近接する場所にないことを確認します。 VM は、ソース Azure Stack Hub、セカンダリ Azure Stack Hub インスタンス、または Azure に復元できます。 |
| グローバル Azure または信頼できるサービス プロバイダーに VM を直接バックアップ/復元する | 推奨 | データのプライバシーと規制の要件を満たすことができるのであれば、グローバル Azure または信頼できるサービス プロバイダーにバックアップを保存できます。 復元時の運用エクスペリエンスの一貫性を得るために、サービス プロバイダーも Azure Stack Hub を実行しているのが理想的です。 |
| 別の Azure Stack Hub インスタンスに VM をレプリケートまたはフェールオーバーする | 推奨 | フェールオーバーの場合、アプリの長時間のダウンタイムを回避できるように、2 つ目の Azure Stack Hub クラウドを完全に稼働させる必要があります。 |
| Azure または信頼できるサービス プロバイダーに VM を直接レプリケート/フェールオーバーする | 推奨 | データのプライバシーと規制の要件を満たすことができるのであれば、グローバル Azure または信頼できるサービス プロバイダーにデータをレプリケートできます。 フェールオーバー後の運用エクスペリエンスの一貫性を得るために、サービス プロバイダーも Azure Stack Hub を実行しているのが理想的です。 |
| アプリ データがある同じ Azure Stack Hub クラウドにバックアップ ターゲットをデプロイする | 推奨されません | 同じ Azure Stack Hub クラウド内にバックアップを保存することは避けてください。 クラウドの計画外のダウンタイムによって、プライマリ データとバックアップ データにアクセスできなくなる可能性があります。 (バックアップと復元の最適化のために) バックアップ ターゲットを仮想アプライアンスとしてデプロイする場合は、すべてのデータが外部のバックアップの場所に継続的にコピーされていることを確認する必要があります。 |
| Azure Stack Hub ソリューションがインストールされている同じラックに物理バックアップ アプライアンスを配置する | サポートされていません | 現時点では、元のソリューションに含まれていない他のデバイスを、トップ オブ ラック スイッチに接続することはできません。 |

## <a name="next-steps"></a>次のステップ

この記事では、Azure Stack Hub にデプロイされたユーザー VM を保護するための一般的なガイドラインについて説明しました。 Azure サービスを使用したユーザー VM の保護については、以下を参照してください。

- [事業継続とディザスター リカバリーへの配慮](https://aka.ms/azurestackbcdrconsiderationswp)

### <a name="azure-backup-server"></a>Azure Backup Server
 - [Azure Backup を使用してファイルやアプリを Azure Stack Hub にバックアップする](https://docs.microsoft.com/azure/backup/backup-mabs-files-applications-azure-stack)
 - [Azure Backup Server による Azure Stack Hub のサポート](https://docs.microsoft.com/azure/backup/ ) 
 
 ### <a name="azure-site-recovery"></a>Azure Site Recovery
 - [Azure Site Recovery による Azure Stack Hub のサポート](https://docs.microsoft.com/azure/site-recovery/)  
 
 ### <a name="partner-products"></a>パートナー製品
 - [Azure Stack Hub データセンター統合のパートナー エコシステムのデータシート](https://aka.ms/azurestackbcdrpartners)

Azure Stack Hub の VM を保護するパートナー製品の詳細については、[Azure Stack Hub でのアプリとデータの保護](https://azure.microsoft.com/blog/protecting-applications-and-data-on-azure-stack/)に関するページをご覧ください。
