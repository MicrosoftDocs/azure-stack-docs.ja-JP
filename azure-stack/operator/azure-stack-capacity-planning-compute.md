---
title: Azure Stack キャパシティ プランニングのコンピューティング | Microsoft Docs
description: Azure Stack デプロイのための容量計画について説明します。
services: azure-stack
documentationcenter: ''
author: prchint
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/31/2019
ms.author: justinha
ms.reviewer: prchint
ms.lastreviewed: 05/31/2019
ms.openlocfilehash: 6afaca6e9bad806f432cf56b79dca5881bb76455
ms.sourcegitcommit: fbd6a7fed4f064113647540329a768347a6cf261
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/07/2019
ms.locfileid: "66810226"
---
# <a name="azure-stack-compute"></a>Azure Stack コンピューティング

Azure Stack 上でサポートされる [VM サイズ](https://docs.microsoft.com/azure-stack/user/azure-stack-vm-sizes)は、Azure 上でサポートされているもののサブセットです。 Azure では、リソース (サーバーのローカルおよびサービス レベル) の過剰消費を防ぐため、多くのベクターに沿ってリソースの制限を適用します。 テナントの消費量にいくつかの制限を適用しないと、あるテナントでリソースが過剰消費された場合に、別のテナントのエクスペリエンスに影響します。 VM からのネットワーク送信の場合、Azure Stack では Azure の制限と一致する帯域幅の上限が設けられます。 Azure Stack のストレージ リソースの場合、ストレージ IOPS 制限で、テナントによるストレージ アクセスのためのリソースの基本的な過剰消費を防ぎます。

>[!IMPORTANT]
>[Azure Stack Capacity Planner](https://aka.ms/azstackcapacityplanner) では、IOPS パフォーマンスは考慮されず、保証されません。

## <a name="vm-placement"></a>VM の配置

Azure Stack 配置エンジンでは、使用可能なホスト間でテナント VM を配置します。

Azure Stack では、VM を配置する際に 2 つの考慮事項が使用されます。 1 つ目は、その VM の種類に十分なメモリがホスト上にあることです。 2 つ目は、VM が[可用性セット](https://docs.microsoft.com/azure/virtual-machines/windows/manage-availability)の一部であるか、[仮想マシン スケール セット](https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview)であることです。

Azure Stack 内でのマルチ VM による実稼働システムの高可用性を実現するため、VM は、複数の障害ドメインに分散される可用性セット内に配置されます。 可用性セット内の障害ドメインは、スケール ユニット内の 1 つのノードとして定義されます。 Azure Stack では、Azure との一貫性がある最大 3 つの障害ドメインを持つ可用性セットを用意することをサポートしています。 可用性セット内に配置された VM は、複数の障害ドメイン (つまり、Azure Stack ホスト) にできる限り均等に分散させることによって、互いに物理的に分離されます。 ハードウェアが故障した場合、障害が発生した障害ドメインの VM は他の障害ドメインで再起動されますが、可能であれば、同じ可用性セット内の他の VM とは別の障害ドメインに保持されます。 ホストがオンラインに戻ると、高可用性を維持するために VM の再配置が行われます。  

仮想マシン スケール セットは、バックエンド上で可用性セットを使用し、各仮想マシン スケール セット インスタンスが異なる障害ドメインに配置されていることを確認します。 つまり、これらは別々の Azure Stack インフラストラクチャ ノードを使用します。 たとえば、4 ノードの Azure Stack システムの場合、3 つのインスタンスの仮想マシン スケール セットの作成時に 4 ノードの容量が不足しているために 3 つの別々の Azure Stack ノードに 3 つの仮想マシン スケール セット インスタンスを配置できない状況になる場合があります。 さらに、Azure Stack ノードは、配置を試行する前に、さまざまなレベルでいっぱいになることがあります。 

Azure Stack ではメモリがオーバーコミットされません。 ただし、物理コア数のオーバーコミットは許可されています。 配置アルゴリズムでは、既存の仮想対物理コアのオーバープロビジョニングの比率を係数と見なさないため、各ホストの比率が異なる可能性があります。 Microsoft では、ワークロードやサービス レベルの要件に差異があるため、仮想対物理コアの比率に対するガイダンスは提供していません。 

## <a name="azure-stack-memory"></a>Azure Stack メモリ 

Azure Stack は、正常にプロビジョニングされた VM の実行を維持するよう設計されています。 たとえば、ハードウェア障害によってホストがオフラインになった場合、Azure Stack は別のホスト上でその VM の再起動を試行します。 2 つ目の例は、Azure Stack ソフトウェアのパッチと更新プログラムです。 物理ホストを再起動する必要がある場合、そのホスト上で実行されている VM をソリューション内の使用可能な別のホストに移動することが試行されます。   

この VM の管理または移動を実現できるのは、再起動または移行が可能なメモリ容量が予約されている場合のみです。 ホストの合計メモリの一部は予約されており、テナント VM の配置に使用することはできません。 

管理ポータルでは、Azure Stack の空きメモリとメモリ使用量を示す円グラフを確認できます。 次の図は、Azure Stack 内にある Azure Stack スケール ユニット上の物理メモリ容量を示しています。

![物理メモリ容量](media/azure-stack-capacity-planning/physical-memory-capacity.png)

メモリ使用量は、いくつかのコンポーネントで構成されます。 次のコンポーネントでは、円グラフの使用セクションでメモリを消費します。  

 -  ホスト OS の使用量または予約 - これは、ホスト上のオペレーティング システム (OS)、仮想メモリ ページ テーブル、ホスト OS 上で実行されているプロセス、およびスペース ダイレクトのメモリ キャッシュによって使用されているメモリです。 この値は、ホストで実行されている別の Hyper-V プロセスで使用されるメモリに依存するため、変動する可能性があります。
 - インフラストラクチャ サービス - これらは Azure Stack を構成するインフラストラクチャです。 Azure Stack の 1904 リリース バージョンの時点では、これには 242 GB + (4 GB × ノード数) のメモリを消費する最大 31 個の VM が含まれます。 インフラストラクチャ サービスをよりスケーラブルで回復性のあるものにするよう取り組んでいるため、インフラストラクチャ サービス コンポーネントのメモリ使用率が変わる可能性があります。
 - 回復性のための予約 - Azure Stack では、1 つのホストの障害発生時にテナントの可用性を確保するため、およびパッチと更新プログラムの適用時に VM のライブ移行を正常に行うために、メモリの一部が予約されます。
 - テナント VM - これらは Azure Stack ユーザーによって作成されたテナント VM です。 実行中の VM だけでなく、ファブリック上に配置されているすべての VM もメモリを消費します。 つまり、"作成中" または "失敗" 状態の VM、またはゲスト内からシャットダウンされた VM でメモリが消費されます。 しかし、portal/powershell/cli から停止 (割り当て解除) オプションを使用して割り当て解除された VM では、Azure Stack のメモリは消費されません。
 - アドオン RP – SQL、MySQL、App Service などのようなアドオン RP 用にデプロイされた VM


ポータル上でメモリ消費量を把握する最善の方法は、[Azure Stack Capacity Planner](https://aka.ms/azstackcapacityplanner) を使用して、さまざまなワークロードの影響を確認することです。 次の計算は、Planner によって使用されているものと同じです。

この計算では、テナントの VM 配置で使用できる、利用可能なメモリの合計が算出されます。 このメモリ容量は、Azure Stack スケール ユニットの全体に対するものです。 


  VM 配置に利用可能なメモリ = ホストの合計メモリ - 回復性のための予約 - 実行中のテナント VM によって使用されているメモリ - Azure Stack インフラストラクチャのオーバーヘッド <sup>1</sup>

  回復性のための予約 = H + R * ((N-1) * H) + V * (N-2)

> 各値の説明:
> - H = 単一サーバーのメモリ サイズ
> - N = スケール ユニットのサイズ (サーバーの数)
> - R = OS オーバーヘッドのためのオペレーティング システムの予約 (この数式では 0.15)<sup>2</sup>
> - V = スケール ユニット内の最大 VM

  <sup>1</sup> Azure Stack インフラストラクチャのオーバーヘッド = 242 GB + (4 GB x ノード数)。 約 31 個の VM が Azure Stack のインフラストラクチャをホストするために使用され、合計で約 242 GB + (4 GB x ノード数) のメモリと 146 個の仮想コアが消費されます。 この VM の数の論理的根拠は、セキュリティ、スケーラビリティ、サービス提供および修正プログラムの適用に関する要件を満たすために必要なサービス分離を行うことです。 この内部サービス構造により、今後、新しいインフラストラクチャ サービスが開発されたときに、そのサービスを導入できるようになります。 

  <sup>2</sup> オーバーヘッドのためのオペレーティング システムの予約 = ノード メモリの 15%。 オペレーティング システムの予約値は概算であり、サーバーおよび一般的なオペレーティング システムのオーバーヘッドの物理メモリ容量によって異なります。


値 V (スケール ユニット内の最大 VM) は、最大テナント VM メモリ サイズに動的に基づきます。 たとえば、最大 VM 値は、7 GB、112 GB、または Azure Stack ソリューションでサポートされるその他の VM メモリのサイズになる場合があります。 Azure Stack ファブリック上で最大の VM を変更すると、VM 自体のメモリの増加に加えて、回復性のための予約が増加します。 

## <a name="frequently-asked-questions"></a>よく寄せられる質問

Q:テナントで新しい VM がデプロイされました。管理者ポータルの容量グラフで残存容量を表示するのにかかる時間はどれくらいですか?
A:容量ブレードは 15 分ごとに更新されるため、それを考慮してください。

Q:Azure Stack にデプロイされている VM の数は変わりませんが、容量は変動しています。 なぜですか?
A:VM の配置で使用できるメモリには複数の依存関係があり、1 つはホスト OS の予約です。 この値は、定数値ではない、ホストで実行されている別の Hyper-V プロセスで使用されるメモリに依存します。

Q:メモリを消費する場合、テナント VM はどの状態である必要がありますか?
A:実行中の VM だけでなく、ファブリック上に配置されているすべての VM もメモリを消費します。 つまり、portal/powershell/cli から停止 (割り当て解除) されたものではなく、"作成中" または "失敗" 状態の VM、あるいはゲスト内からシャットダウンされた VM でメモリが消費されます。


Q:4 ホストの Azure Stack があります。 テナントには VM が 3 つあり、それぞれ 56 GB の RAM (D5_v2) が消費されています。 VM の 1 つが 112 GB RAM (D14_v2) にサイズ変更されており、ダッシュボードの使用可能なメモリ レポートの結果、容量ブレードの使用量が 168 GB に急増しました。 その後、他の 2 つの D5_v2 VM を D14_v2 にサイズ変更すると、それぞれ RAM が 56 GB だけ増えました。 これはなぜですか?

A:使用可能なメモリは、Azure Stack で管理される回復性のための予約の関数です。 回復性のための予約は、Azure Stack スタンプの最大 VM サイズの関数です。 最初は、スタンプの最大 VM は 56 GB メモリでした。 VM のサイズが変更されたときに、スタンプの最大 VM は 112 GB メモリとなり、そのテナント VM で使用されたメモリが増えただけでなく、回復性のための予約も増えました。 その結果、56 GB (テナント VM メモリが 56 GB から 112 GB に増加) + 112 GB (回復性のための予約メモリの増加) の増加となりました。 後続の VM のサイズが変更されたときに、最大 VM サイズは 112 GB VM のままだったため、結果として、回復性のための予約は増えませんでした。 メモリ使用量の増加は、テナント VM メモリの増加 (56 GB) のみでした。 


> [!NOTE]
> ネットワークに関する容量計画要件は、パブリック VIP のサイズが構成可能である場合にのみ、最小要件となります。 Azure Stack にパブリック IP アドレスをさらに追加する方法については、「[Public IP Addresses を追加する](azure-stack-add-ips.md)」を参照してください。

## <a name="next-steps"></a>次の手順
[Azure Stack ストレージ](azure-stack-capacity-planning-storage.md)について確認する
