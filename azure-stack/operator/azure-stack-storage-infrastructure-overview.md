---
title: Azure Stack Hub 用のストレージ インフラストラクチャを管理する
titleSuffix: Azure Stack
description: Azure Stack Hub 用のストレージ インフラストラクチャを管理する方法について説明します。
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: ''
ms.topic: article
ms.date: 08/27/2019
ms.author: mabrigg
ms.lastreviewed: 03/11/2019
ms.reviewer: jiahan
ms.openlocfilehash: 508036c399b44fc6de50c11955417c5a0732d8bc
ms.sourcegitcommit: c4368652f0dd68c432aa1dabddbabf161a4a6399
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/13/2020
ms.locfileid: "75914993"
---
# <a name="manage-storage-infrastructure-for-azure-stack-hub"></a>Azure Stack Hub 用のストレージ インフラストラクチャを管理する

*適用対象:Azure Stack Hub 統合システムと Azure Stack Development Kit*

この記事では、Azure Stack Hub のストレージ インフラストラクチャ リソースの正常性状態と操作状態について説明します。 この種のリソースには、ストレージ ドライブとストレージ ボリュームがあります。 このトピックの情報は、プールにドライブを追加できないなど、さまざまな問題のトラブルシューティングを行うときに役に立ちます。

## <a name="understand-drives-and-volumes"></a>ドライブとボリュームについて

### <a name="drives"></a>ドライブ

Windows Server ソフトウェアの機能を利用して、Azure Stack Hub では、記憶域スペース ダイレクト (S2D) と Windows Server フェールオーバー クラスタリングの組み合わせでストレージ機能が定義されています。 この組み合わせにより、パフォーマンス、スケーラビリティ、回復性の優れたストレージ サービスが提供されます。

Azure Stack Hub の統合システム パートナーからは、ストレージの幅広い柔軟性など、バリエーション豊かなソリューションが提供されています。 ドライブは現在、次の 3 種類を選んで組み合わせることができます:NVMe (Non-Volatile Memory Express)、SATA/SAS SSD (ソリッドステート ドライブ)、HDD (ハード ディスク ドライブ)。

記憶域スペース ダイレクトは、キャッシュを使ってストレージのパフォーマンスを最大化する機能です。 1 種類以上のドライブを備えた Azure Stack Hub アプライアンスでは、記憶域スペース ダイレクトにより "最も高速な" 種類のドライブ (NVMe &gt; SSD &gt; HDD) がすべて、自動的にキャッシュとして使用されます。 残りのドライブは、キャパシティとして使用されます。 ドライブは "オールフラッシュ" と "ハイブリッド" のいずれかのデプロイにグループ化することができます。

![Azure Stack Hub のストレージ インフラストラクチャ](media/azure-stack-storage-infrastructure-overview/image1.png)

オールフラッシュ型のデプロイは、ストレージのパフォーマンスを最大化することを目標としたものであり、回転式のハード HDD が含まれません。

![Azure Stack Hub のストレージ インフラストラクチャ](media/azure-stack-storage-infrastructure-overview/image2.png)

ハイブリッド型のデプロイは、パフォーマンスとキャパシティのバランスの調和またはキャパシティの最大化を目標としたもので、回転式の HDD が含まれます。

キャッシュの動作は、キャッシュの対象となるドライブの種類に応じて自動的に決まります。 キャッシュの対象が SSD の場合 (SSD のキャッシュを NVMe に保存する場合など) には、書き込みのみがキャッシュに保存されます。 こうすることによって、キャパシティ ドライブに流入するトラフィックの累積量を減らし、キャパシティ ドライブの劣化スピードを遅らせ、ドライブの寿命を延ばしています。 その間、読み取りがキャッシュに保存されることはありません。 キャッシュに保存されないのは、読み取りがフラッシュの寿命に及ぼす影響はわずかであり、SSD の読み取り遅延は常に低いためです。 キャッシュの対象が HDD の場合 (HDD のキャッシュを SSD に保存する場合など) には、読み取りと書き込みのどちらにもフラッシュと同等の待ち時間 (多くの場合、約 10 倍のスピード) を実現できるよう、読み取りと書き込みの両方がキャッシュに保存されます。

![Azure Stack Hub のストレージ インフラストラクチャ](media/azure-stack-storage-infrastructure-overview/image3.png)

利用できるストレージ構成については、Azure Stack Hub OEM パートナー (https://azure.microsoft.com/overview/azure-stack/partners/) にお問い合わせのうえ、仕様の詳細をご確認ください。

> [!Note]  
> Azure Stack Hub アプライアンスは、HDD ドライブと SSD (または NVMe) ドライブの両方を備えたハイブリッド デプロイとしてお届けすることができます。 ただし、高速な方のドライブはキャッシュ ドライブ、残りのドライブはすべてキャパシティ ドライブ プールとして、それぞれ使用されます。 テナント データ (BLOB、テーブル、キュー、ディスク) は、キャパシティ ドライブに保存されます。 Premium ディスクをプロビジョニングしたり、Premium ストレージ アカウントの種類を選択しても、オブジェクトが SSD ドライブまたは NVMe ドライブに割り当てられる保証はありません。

### <a name="volumes"></a>ボリューム

"*ストレージ サービス*" では、利用可能なストレージが複数のボリュームにパーティション分割されます。分割によってできた個別のボリュームは、システム データとテナント データを保持するために割り当てられます。 記憶域プール内のドライブを組み合わせたボリュームでは、記憶域スペース ダイレクトのフォールト トレランス、スケーラビリティ、パフォーマンス面のメリットが提供されます。

![Azure Stack Hub のストレージ インフラストラクチャ](media/azure-stack-storage-infrastructure-overview/image4.png)

Azure Stack Hub の記憶域プール上に作成されるボリュームは 3 種類あります。

- インフラストラクチャ: Azure Stack Hub インフラストラクチャ VM とコア サービスによって使用されるファイルがホストされます。

- VM 一時: テナント VM にアタッチされている一時ディスクと、そのディスクに格納されているデータをホストします。

- オブジェクト ストア: BLOB、テーブル、キュー、VM ディスクにサービスを提供するテナント データがホストされます。

複数ノードのデプロイの場合、インフラストラクチャ ボリュームの数は 3 つです。これに対して、VM 一時ボリュームとオブジェクト ストア ボリュームの数は、Azure Stack Hub デプロイ内のノードの数に等しくなります。

- 4 ノードのデプロイでは、VM 一時ボリューム、オブジェクト ストア ボリュームとも、同一のものがそれぞれ 4 つずつあります。

- クラスターに新しいノードを 1 つ追加すると、両方の種類のボリュームが 1 つずつ新たに作成されます。

- ボリュームの数は、ノードに不具合が発生したり、ノードを削除したりした場合でもそのまま維持されます。

- Azure Stack Hub 開発キットを使用する場合は、複数の共有を含む 1 つのボリュームがあります。

記憶域スペース ダイレクト内のボリュームでは、ドライブやサーバーの障害などのハードウェアの問題から保護するための回復性が提供されます。 また、ソフトウェアの更新など、サーバーのメンテナンスを通して継続的な可用性が実現されます。 Azure Stack Hub のデプロイでは、データの回復性確保のために 3 方向のミラーリングが使用されます。 テナント データのコピーが 3 つ、別々のサーバーに書き込まれ、キャッシュに保存されます。

![Azure Stack Hub のストレージ インフラストラクチャ](media/azure-stack-storage-infrastructure-overview/image5.png)

ミラーリングを使ってあらゆるデータのコピーを複数保持することによって、フォールト トレランスが実現します。 データをどのようにストライピングおよび配置するかは重要な問題ですが、ミラーリングを使って格納するデータがいずれも、そのままの形で複数回書き込まれるという点は間違いありません。 コピーはそれぞれ、障害の発生が個別にとどまることが想定される別々の物理ハードウェア (別のサーバーの別のドライブ) に書き込まれます。 3 方向ミラーリングでは、一度に 2 台以上のハードウェア (ドライブまたはサーバー) に問題が発生した場合でも、安全に耐えることができます。 たとえば、あるサーバーの再起動中に別のドライブまたはサーバーに突然障害が発生した場合でも、あらゆるデータが安全かつアクセス可能な状態に保たれます。

## <a name="volume-states"></a>ボリュームの状態

ボリュームの状態を確認するには、次の PowerShell コマンドを使用します。

```powershell
$scaleunit_name = (Get-AzsScaleUnit)[0].name

$subsystem_name = (Get-AzsStorageSubSystem -ScaleUnit $scaleunit_name)[0].name

Get-AzsVolume -ScaleUnit $scaleunit_name -StorageSubSystem $subsystem_name | Select-Object VolumeLabel, HealthStatus, OperationalStatus, RepairStatus, Description, Action, TotalCapacityGB, RemainingCapacityGB
```

デタッチされているボリュームと、デグレード状態または不完全な状態のボリュームを示す出力の例は次のとおりです。

| VolumeLabel | HealthStatus | OperationalStatus |
|-------------|--------------|------------------------|
| ObjStore_1 | Unknown | デタッチ |
| ObjStore_2 | 警告 | {デグレード、Incomplete (不完全)} |

以降のセクションでは、正常性状態と操作状態について説明します。

### <a name="volume-health-state-healthy"></a>ボリュームの正常性状態:Healthy

| 操作状態 | [説明] |
|---|---|
| [OK] | ボリュームは正常な状態です。 |
| Suboptimal (最適でない) | データが複数のドライブに均等に書き込まれていません。<br> <br>**アクション:** 記憶域プール内のドライブの使用を最適化するために、サポートにお問い合わせください。 それに先立って、 https://aka.ms/azurestacklogfiles に記載されているガイダンスを使用してログ ファイルの収集プロセスを開始してください。 失敗した接続を復元した後に、バックアップからの復元が必要になることがあります。 |

### <a name="volume-health-state-warning"></a>ボリュームの正常性状態:警告

ボリュームの正常性状態が警告のときは、データの 1 つ以上のコピーが利用不可能な状態になっているものの、Azure Stack Hub では依然としてデータの少なくとも 1 つのコピーを読み取れることを示します。

| 操作状態 | [説明] |
|---|---|
| サービス中 | ドライブを追加または削除した後などに、Azure Stack Hub がボリュームを修復している最中です。 修復が完了したら、ボリュームの正常性状態が [OK] に戻ります。<br> <br>**アクション:** Azure Stack Hub がボリュームの修復を終えるまで待ち、修復が終わったら状態を確認します。 |
| Incomplete (不完全) | 障害が発生しているドライブや、見つからないドライブが 1 つ以上あるため、ボリュームの回復性が低下しています。 ただし、見つからないドライブにはデータの最新のコピーが格納されています。<br> <br>**アクション:** 見つからなかったドライブを再接続し、障害が発生したドライブを交換します。また、オフラインになっているサーバーがあれば、オンラインに復帰させます。 |
| 低下しています | 障害が発生しているドライブや、見つからないドライブが 1 つ以上あり、ドライブに格納されているデータのコピーも古くなっているため、ボリュームの回復性が低下しています。<br> <br>**アクション:** 見つからなかったドライブを再接続し、障害が発生したドライブを交換します。また、オフラインになっているサーバーがあれば、オンラインに復帰させます。 |

### <a name="volume-health-state-unhealthy"></a>ボリュームの正常性状態:異常

ボリュームの状態が [異常] のときは、ボリューム上のデータの一部または全部にアクセスできなくなっています。

| 操作状態 | [説明] |
|---|---|
| No redundancy (冗長性なし) | 障害が発生したドライブが多すぎるため、ボリュームからデータが失われました。<br> <br>**アクション:** サポートにお問い合わせください。 それに先立って、 https://aka.ms/azurestacklogfiles に記載されているガイダンスを使用してログ ファイルの収集プロセスを開始してください。 |

### <a name="volume-health-state-unknown"></a>ボリュームの正常性状態:Unknown

このほか、仮想ディスクがデタッチされた場合には、ボリュームの正常性が [不明] になることもあります。

| 操作状態 | [説明] |
|---|---|
| デタッチ | ストレージ デバイスの障害が発生しており、ボリュームにアクセスできなくなる可能性があります。 一部のデータが失われるおそれがあります。<br> <br>**アクション:** <br>1.ストレージ デバイスすべてについて、物理的な接続状態とネットワーク接続の状況を確認します。<br>2.デバイスがすべて正しく接続できている場合は、サポートにお問い合わせください。 それに先立って、 https://aka.ms/azurestacklogfiles に記載されているガイダンスを使用してログ ファイルの収集プロセスを開始してください。 失敗した接続を復元した後に、バックアップからの復元が必要になることがあります。 |

## <a name="drive-states"></a>ドライブの状態

ドライブの状態を監視するには、次の PowerShell コマンドを使用します。

```powershell
$scaleunit_name = (Get-AzsScaleUnit)[0].name

$subsystem_name = (Get-AzsStorageSubSystem -ScaleUnit $scaleunit_name)[0].name

Get-AzsDrive -ScaleUnit $scaleunit_name -StorageSubSystem $subsystem_name | Select-Object StorageNode, PhysicalLocation, HealthStatus, OperationalStatus, Description, Action, Usage, CanPool, CannotPoolReason, SerialNumber, Model, MediaType, CapacityGB
```

以降のセクションでは、ドライブの正常性状態について説明します。

### <a name="drive-health-state-healthy"></a>ドライブの正常性状態:Healthy

| 操作状態 | [説明] |
|---|---|
| [OK] | ボリュームは正常な状態です。 |
| サービス中 | ドライブ内部でハウスキープ処理を実行中です。 処理が完了したら、ドライブの正常性状態が [OK] に戻ります。 |

### <a name="drive-health-state-healthy"></a>ドライブの正常性状態:Healthy

ドライブが [警告] 状態の場合には、データの読み取りと書き込みは正常に実行できるものの、ドライブに何らかの問題が発生しています。

| 操作状態 | [説明] |
|---|---|
| 通信の切断 | ドライブへの接続が失われました。<br> <br>**アクション:** サーバーをすべてオンラインに戻します。 問題が解決しない場合には、ドライブを再接続します。 この状態が続く場合には、回復性確保のためにドライブを交換します。 |
| 予測される障害 | ドライブに間もなく障害が発生することが予想されます。<br> <br>**アクション:** 回復性確保のために、できるだけ早くドライブを交換します。 |
| IO エラー | ドライブにアクセスする際に一時的なエラーが発生しました。<br> <br>**アクション:** この状態が続く場合には、回復性確保のためにドライブを交換します。 |
| 一時的なエラー | ドライブに一時的なエラーが発生しました。 このエラーは通常、ドライブから応答がないことを示していますが、記憶域スペース ダイレクトの保護パーティションがドライブから不適切に削除されたことを示している可能性もあります。 <br> <br>**アクション:** この状態が続く場合には、回復性確保のためにドライブを交換します。 |
| Abnormal latency (待機時間の異常) | ドライブが応答しないことがあり、障害の兆候が見られます。<br> <br>**アクション:** この状態が続く場合には、回復性確保のためにドライブを交換します。 |
| Removing from pool (プールから削除中) | Azure Stack Hub では、記憶域プールからドライブが削除されています。<br> <br>**アクション:** Azure Stack Hub でのドライブの削除が終わるまで待ち、削除が終わったら状態を確認します。<br>状態が変化しない場合は、サポートにお問い合わせください。 それに先立って、 https://aka.ms/azurestacklogfiles に記載されているガイダンスを使用してログ ファイルの収集プロセスを開始してください。 |
| Starting maintenance mode (メンテナンス モードを起動中) | Azure Stack Hub では、ドライブをメンテナンス モードに移行する処理が行われています。 この状態は一時的なものであり、ドライブはすぐにメンテナンス モードになるはずです。<br> <br>**アクション:** Azure Stack Hub の処理が終わるまで待ち、その後で状態を確認します。 |
| メンテナンス モード | ドライブがメンテナンス モードになっており、ドライブからの読み取りと書き込みが停止しています。 この状態は通常、PNU や FRU などの Azure Stack Hub 管理タスクがドライブで行われていることを示します。 ただし、管理者もドライブをメンテナンス モードに移行させることができます。<br> <br>**アクション:** Azure Stack Hub の管理タスクが終わるまで待ち、その後で状態を確認します。<br>状態が変化しない場合は、サポートにお問い合わせください。 それに先立って、 https://aka.ms/azurestacklogfiles に記載されているガイダンスを使用してログ ファイルの収集プロセスを開始してください。 |
| Stopping maintenance mode (メンテナンス モードを停止中) | Azure Stack Hub では、ドライブをオンラインに復帰させる処理が行われています。 この状態は一時的なものであり、ドライブはすぐに別の状態 (理想的には正常) に変わります。<br> <br>**アクション:** Azure Stack Hub の処理が終わるまで待ち、その後で状態を確認します。 |

### <a name="drive-health-state-unhealthy"></a>ドライブの正常性状態:異常

状態が [異常] のドライブには、書き込みまたはアクセスができません。

| 操作状態 | [説明] |
|---|---|
| Split | ドライブがプールから隔離されています。<br> <br>**アクション:** ドライブを新しいディスクに交換します。 このディスクを使う必要がある場合は、ディスクをシステムから取り外したうえで、ディスクに有用なデータが一切ないことを確認してから、ディスクを消去し、同じディスクをもう一度取り付けます。 |
| 使用不可 | 物理ディスクがソリューション ベンダーによりサポートされていないため、ディスクが検疫されています。 サポートされるのは、ソリューションでの利用が承認され、正しいディスク ファームウェアを備えたディスクのみです。<br> <br>**アクション:** ドライブを、ソリューションでの利用が承認されている製造元とモデルの番号を備えたディスクに交換します。 |
| 古いメタデータ | 交換した新しいディスクは以前に使用されていたものであり、不明なストレージ システムのデータが残っている可能性があります。 ディスクは検疫されています。 <br> <br>**アクション:** ドライブを新しいディスクに交換します。 このディスクを使う必要がある場合は、ディスクをシステムから取り外したうえで、ディスクに有用なデータが一切ないことを確認してから、ディスクを消去し、同じディスクをもう一度取り付けます。 |
| 認識されないメタデータ | 認識されないメタデータが見つかりました。これは通常、ドライブに別のプールのメタデータが存在することを示しています。<br> <br>**アクション:** ドライブを新しいディスクに交換します。 このディスクを使う必要がある場合は、ディスクをシステムから取り外したうえで、ディスクに有用なデータが一切ないことを確認してから、ディスクを消去し、同じディスクをもう一度取り付けます。 |
| エラーのあるメディア | ドライブにエラーが発生したので、このドライブが今後記憶域スペースで使われることはありません。<br> <br>**アクション:** 回復性確保のために、できるだけ早くドライブを交換します。 |
| Device hardware failure (デバイスのハードウェア障害) | このデバイスでハードウェア障害が発生しました。 <br> <br>**アクション:** 回復性確保のために、できるだけ早くドライブを交換します。 |
| Updating firmware (ファームウェアを更新中) | Azure Stack Hub でドライブのファームウェアが更新されています。 この状態は一時的なものであり、通常は 1 分未満で終了します。その間、読み取りと書き込みはすべて、プール内の別のドライブにより処理されます。<br> <br>**アクション:** Azure Stack Hub の更新処理が終わるまで待ち、その後で状態を確認します。 |
| 開始中 | ドライブが稼働開始のための準備をしている状態です。 この状態は一時的なものであり、準備が完了すると、ドライブは別の操作状態に移行します。<br> <br>**アクション:** Azure Stack Hub の処理が終わるまで待ち、その後で状態を確認します。 |

## <a name="reasons-a-drive-cant-be-pooled"></a>ドライブをプールできない理由

一部のドライブは、Azure Stack Hub の記憶域プールに入れる準備ができていません。 ドライブをプールできない理由は、ドライブの `CannotPoolReason` プロパティを見ると確認できます。 次の表は、それぞれの理由をもう少し詳しく説明したものです。

| 理由 | [説明] |
|---|---|
| Hardware not compliant (非準拠ハードウェア) | ドライブが、ヘルス サービスを使用して指定された承認済みのストレージ モデルの一覧に存在しません。<br> <br>**アクション:** ドライブを新しいディスクに交換します。 |
| Firmware not compliant (非準拠ファームウェア) | 物理ドライブ上のファームウェアが、ヘルス サービスを使用して指定された承認済みのファームウェア リビジョンの一覧に存在しません。<br> <br>**アクション:** ドライブを新しいディスクに交換します。 |
| In use by cluster (クラスターで使用中) | ドライブが現在、フェールオーバー クラスターによって使用されています。<br> <br>**アクション:** ドライブを新しいディスクに交換します。 |
| リムーバブル メディア | ドライブがリムーバブル ドライブとして分類されています。 <br> <br>**アクション:** ドライブを新しいディスクに交換します。 |
| 異常 | ドライブが正常な状態にないため、交換が必要な可能性があります。<br> <br>**アクション:** ドライブを新しいディスクに交換します。 |
| Insufficient capacity (容量の不足) | ドライブの空き領域を占有しているパーティションがあります。<br> <br>**アクション:** ドライブを新しいディスクに交換します。 このディスクを使う必要がある場合は、ディスクをシステムから取り外したうえで、ディスクに有用なデータが一切ないことを確認してから、ディスクを消去し、同じディスクをもう一度取り付けます。 |
| Verification in progress (検証中) | ドライブまたはドライブ上のファームウェアの利用が承認されているかどうかについて、ヘルス サービスによる確認が進行中です。<br> <br>**アクション:** Azure Stack Hub の処理が終わるまで待ち、その後で状態を確認します。 |
| 検証できませんでした | ドライブまたはドライブ上のファームウェアの利用が承認されているかどうかについて、ヘルス サービスによる確認ができませんでした。<br> <br>**アクション:** サポートにお問い合わせください。 それに先立って、 https://aka.ms/azurestacklogfiles に記載されているガイダンスを使用してログ ファイルの収集プロセスを開始してください。 |
| オフライン | ドライブがオフラインになっています。 <br> <br>**アクション:** サポートにお問い合わせください。 それに先立って、 https://aka.ms/azurestacklogfiles に記載されているガイダンスを使用してログ ファイルの収集プロセスを開始してください。 |

## <a name="next-step"></a>次のステップ

[ストレージ容量の管理](azure-stack-manage-storage-shares.md) 
